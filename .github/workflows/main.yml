name: Build-OpenWrt-X86-10G

on:
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    # 用 22.04 更稳定，避免 python3-distutils 问题
    runs-on: ubuntu-22.04
    timeout-minutes: 2400
    permissions:
      contents: write

    steps:
      - name: Checkout repository (this repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
            git gettext libncurses-dev libssl-dev python3 python3-pip python3-setuptools \
            rsync unzip zlib1g-dev file wget subversion swig time xsltproc ccache

      - name: Clone official OpenWrt source
        run: |
          # clone official OpenWrt (shallow clone can be used to save time, but full is more stable)
          git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt || git clone https://github.com/openwrt/openwrt.git openwrt
          ls -la openwrt

      - name: Copy feeds.conf.default and config/.config into openwrt (if present)
        run: |
          # Copy feeds.conf.default and config/.config from repo root into openwrt
          if [ -f feeds.conf.default ]; then
            cp feeds.conf.default openwrt/feeds.conf.default
            echo "Copied feeds.conf.default"
          else
            echo "No feeds.conf.default in repo root (ok if you don't use custom feeds)"
          fi

          if [ -f config/.config ]; then
            cp config/.config openwrt/.config
            echo "Copied custom config to openwrt/.config"
          else
            echo "No config/.config found in repo (you can add one later)"
          fi

      - name: Add common community packages to package/community (avoid feed mismatch)
        run: |
          cd openwrt
          mkdir -p package/community
          # 常见第三方仓库，若某个地址变更会失败，但不会影响整体（命令用 || true）
          git clone --depth 1 https://github.com/xiaorouji/openwrt-passwall-packages.git package/community/passwall-packages || true
          git clone --depth 1 https://github.com/xiaorouji/openwrt-passwall.git package/community/passwall || true
          git clone --depth 1 https://github.com/fw876/helloworld.git package/community/helloworld || true
          git clone --depth 1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/community/adguard || true
          git clone --depth 1 https://github.com/pymumu/smartdns.git package/community/smartdns || true
          ls -la package/community || true

      - name: Update & install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Ensure .config exists (or create minimal default)
        run: |
          cd openwrt
          if [ -f .config ]; then
            echo ".config exists"
            sed -n '1,200p' .config || true
          else
            echo "No .config found — creating a minimal x86_64 .config with 10GB rootfs"
            cat > .config <<'EOF'
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_ROOTFS_EXT4FS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=10240
CONFIG_TARGET_IMAGES_GZIP=n
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-ssl=y
# add other default packages if you want
EOF
            sed -n '1,200p' .config || true
          fi

      - name: Prepare build (defconfig + download)
        run: |
          cd openwrt
          make defconfig
          make download -j8 || true

      - name: Build OpenWrt (can be long)
        run: |
          cd openwrt
          # 首先尝试并行编译，失败则退化到单线程以便查看错误
          make -j$(nproc) V=s || (make -j1 V=s)

      - name: Upload build artifacts (firmware)
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-x86-10g
          path: openwrt/bin/targets/x86/64/
